好的，这是根据您提供的最新代码文件更新后的 README 文件。

---

# STM32 智能小车项目

## 1. 项目简介

这是一个基于 STM32F446RET6 微控制器的智能小车项目。该小车集成了多种传感器和模块，可以通过蓝牙进行远程控制，并实时回传传感器数据。

项目主要功能包括：

* **电机控制**: 使用 PWM 控制电机，实现小车的前进、后退、左转、右转和停止。
* **蓝牙遥控**: 通过 USART1 接收蓝牙模块发送的指令，控制小车运动。
* **激光雷达 (RPLIDAR C1)**: 通过 USART6 和 DMA 接收激光雷达数据，实时获取周围环境的距离和角度信息。
* **惯性测量单元 (MPU6500)**: 通过 I2C 读取 MPU6500 的加速度和陀螺仪数据，用于姿态检测和运动状态分析。
* **编码器测速**: 使用定时器的编码器模式，精确测量电机转速。
* **ADC 电压采集**: 通过 ADC 采集电压信息，可用于电池电量监测等。

所有传感器数据都可以通过蓝牙串口发送到上位机，方便调试和数据分析。

## 2. 硬件清单

| 组件 | 型号 | 连接方式 |
| :--- | :--- | :--- |
| 微控制器 | STM32F446RET6 | - |
| 蓝牙模块 | HC-04 | USART1 |
| 激光雷达 | RPLIDAR C1 | USART6 |
| 惯性测量单元 | MPU6500 | I2C1 |
| 电机驱动 | L298N 或类似 | TIM3 (PWM) |
| 编码器电机 | - | TIM2, TIM4 |
| ADC采样电路 | - | ADC1_IN2 |

## 3. 功能实现

### 3.1. 运动控制

* **遥控指令**: 通过蓝牙发送单个字符指令来控制小车的运动状态：
    * `'0'`: 停止
    * `'1'`: 前进
    * `'2'`: 后退
    * `'3'`: 左转
    * `'4'`: 右转
* **速度控制**: 采用速度爬升机制（`UpdateSpeedRamp` 函数），使小车加速和减速更加平滑，避免电流冲击。
* **电机驱动**: 使用 TIM3 的 4 路 PWM 信号，分别控制两个电机的正反转。`ControlMotor` 函数负责根据方向和速度设置 PWM 占空比。

### 3.2. 传感器数据处理

* **RPLIDAR C1**:
    * 使用 USART6 (波特率 460800) 配合 DMA 接收雷达数据，减轻 CPU 负担。
    * `ProcessLidarDataFromDMA` 函数从 DMA 缓冲区中解析雷达数据包，包括起始响应包和采样数据包。
    * 实现了超时恢复机制 (`LidarTimeoutRecovery`)，当长时间未收到雷达数据时，会自动重置并重新启动扫描。
* **MPU6500**:
    * 通过 I2C1 与 MPU6500 通信。
    * `MPU6500_Init` 函数完成初始化，`MPU6500_Calibrate` 在启动时进行校准，以消除零点漂移。
    * 在主循环中，定时读取加速度和陀螺仪的原始数据，并进行单位转换和低通滤波。
* **编码器**:
    * TIM2 和 TIM4 配置为编码器模式，用于捕捉电机转动产生的脉冲。
    * 定时读取编码器计数值，计算并发送电机的实时转速 (RPM)。

## 4. 软件架构

### 4.1. `main.c` 核心逻辑

* **初始化**:
    * `SystemClock_Config()`: 配置系统时钟为 180MHz。
    * 各外设初始化，包括 GPIO, DMA, ADC, TIM, USART 和 I2C。
    * 启动 PWM 和编码器定时器。
    * 初始化蓝牙、激光雷达和 MPU6500。
* **主循环 (`while(1)`)**:
    * `SendConnectionNotification()`: 检查蓝牙连接状态，并在连接成功时发送 "Connected" 消息。
    * `UpdateSpeedRamp()`: 根据目标方向和速度，平滑地更新电机状态。
    * `LidarTimeoutRecovery()`: 监控激光雷达数据流，必要时进行恢复。
    * **定时任务**:
        * 每 5ms 处理一次激光雷达 DMA 数据。
        * 每 20ms 读取一次编码器和 ADC 数据，并通过蓝牙发送。
        * 每 50ms 读取一次 MPU6500 数据，并发送。

### 4.2. 数据通信格式

所有传感器数据都以 ASCII 字符串的形式，通过蓝牙串口 (USART1) 发送，以 `\r\n` 结尾。

* **激光雷达**: `D:%.0f,A:%.1f,Q:%d\r\n` (距离, 角度, 质量)
* **编码器**: `E:%.1f,%.1f\r\n` (电机 A 的 RPM, 电机 B 的 RPM)
* **ADC**: `A:%d\r\n` (ADC 原始值)
* **MPU6500**: `M:%.1f,%.1f,%.1f,%.1f,%.1f,%.1f,%.1f,%.1f\r\n` (加速度 X/Y/Z, 陀螺仪 X/Y/Z, X 轴速度, X 轴距离)

## 5. 引脚配置 (`dianji.ioc`)

| 引脚 | 功能 | 描述 |
| :--- | :--- | :--- |
| PA9 | `USART1_TX` | 蓝牙串口发送 |
| PA10 | `USART1_RX` | 蓝牙串口接收 |
| PC6 | `USART6_TX` | RPLIDAR C1 发送 |
| PC7 | `USART6_RX` | RPLIDAR C1 接收 |
| PB8 | `I2C1_SCL` | MPU6500 时钟线 |
| PB9 | `I2C1_SDA` | MPU6500 数据线 |
| PA0, PA1 | `TIM2_CH1`, `TIM2_CH2` | 编码器 A 输入 |
| PB6, PB7 | `TIM4_CH1`, `TIM4_CH2` | 编码器 B 输入 |
| PA6, PA7, PB0, PB1 | `TIM3_CH1` to `CH4` | 电机 PWM 输出 |
| PA2 | `ADC1_IN2` | ADC 输入通道 2 |

## 6. 如何编译和使用

1.  使用 STM32CubeMX 打开 `dianji.ioc` 文件可以查看或修改硬件配置。
2.  在 Keil MDK 或其他支持的环境中打开 `MDK-ARM/dianji.uvprojx` 项目文件。
3.  编译项目，生成 `.hex` 文件。
4.  将 `.hex` 文件烧录到 STM32F446RET6 开发板。
5.  连接好所有硬件模块。
6.  通过手机或电脑的蓝牙串口助手连接小车，发送指令进行控制和数据查看。

---
